aliases:
  - &working_directory ~/flopflip

  - &restore_yarn_cache
    keys:
      - v1-yarn-cache-{{ checksum "yarn.lock" }}
      - v1-yarn-cache

  - &save_yarn_cache
    key: v1-yarn-cache-{{ checksum "yarn.lock" }}
    paths:
      - node_modules

  - &install
    name: Installing
    # Ignoring scripts (e.g. post-install) to gain more control
    # in the jobs to only e.g. build when explicitely needed.
    command: yarn install --pure-lockfile

  - &lint
    name: Linting
    command: yarn lint

  - &type_check
    name: Type checking
    command: yarn flow

  - &bundlesize
    name: Checking bundle sizes
    command: yarn test:bundlesize

  - &build
    name: Building
    command: yarn build

  - &unit_test
    name: Unit testing
    # Limiting the workers of Jest to 10
    # as the build otherwise dies due to resouce restrictions.
    command: yarn test:ci --maxWorkers=10

  - &unit_test_with_coverage
    name: Unit testing (with coverage report)
    command: yarn test:ci:coverage

node6Environment: &node6Environment
  docker:
    - image: circleci/node:6@sha256:e49c8c74394f369f60e24d0dec65b4097058769d68e44536a96bcfc67e934d01
  working_directory: *working_directory
node8Environment: &node8Environment
  docker:
    - image: circleci/node:8@sha256:257fdc7e2949a9576e1a96364e0428d461d0505167c70dcc3e6c3825ce8a6557
  working_directory: *working_directory

version: 2
jobs:
  build:
    <<: *node8Environment
    steps:
      - checkout
      - run: *install
      - restore-cache: *restore_yarn_cache
      - run: *build
  bundlesize:
    <<: *node8Environment
    steps:
      - checkout
      - restore-cache: *restore_yarn_cache
      - run: *install
      - run: *build
      - run: *bundlesize
  lint:
    <<: *node8Environment
    steps:
      - checkout
      - restore-cache: *restore_yarn_cache
      - run: *install
      - run: *build
      - run: *lint
  type_check:
    <<: *node8Environment
    steps:
      - checkout
      - restore-cache: *restore_yarn_cache
      - run: *install
      - run: *build
      - run: *type_check
  build_test_unit_node_6:
    <<: *node6Environment
    steps:
      - checkout
      - restore-cache: *restore_yarn_cache
      - run: *install
      - run: *build
      - run: *unit_test
  build_test_unit_node_8:
    <<: *node8Environment
    steps:
      - checkout
      - restore-cache: *restore_yarn_cache
      - run: *install
      - run: *build
      - run: *unit_test_with_coverage

workflows:
  version: 2
  build_and_test:
    jobs:
      - lint
      - type_check:
      - build_test_unit_node_6:
          requires:
            - lint
            - type_check
      - build_test_unit_node_8:
          requires:
            - lint
            - type_check
      - bundlesize_check:
          requires:
            - build_test_unit_node_6
            - build_test_unit_node_8
