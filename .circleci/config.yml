version: 2.1

aliases:
  - &working_directory ~/flopflip

  - &restore_yarn_cache
    name: "Restoring yarn cache"
    keys:
      - v3-yarn-cache-{{ checksum "yarn.lock" }}
      - v3-yarn-cache

  - &save_yarn_cache
    name: "Saving yarn cache"
    key: v3-yarn-cache-{{ checksum "yarn.lock" }}
    paths:
      - ~/.cache/yarn

executors:
  node_8:
    docker:
      - image: circleci/node:8
    working_directory: *working_directory
  node_10:
    docker:
      - image: circleci/node:10
    working_directory: *working_directory

commands:
  install_dependencies:
    description: "Installing dependencies"
    steps:
      - run: yarn install --pure-lockfile
  build_artefacts:
    description: "Building artefacts"
    steps:
      - run: yarn build
  lint_code:
    description: "Running linters"
    steps:
      - run: yarn lint
  type_check:
    description: "Running type checkers"
    steps:
      - run: yarn flow
  check_artefacts_bundlesizes:
    description: "Running bundlesize check"
    steps:
      - run: yarn test:sizes
  unit_test:
    description: "Running unit tests without covereage"
    steps:
      # Limiting the workers of Jest to 10
      # as the build otherwise dies due to resouce restrictions.
      - run: yarn test:ci --maxWorkers=10
  unit_test_with_coverage:
    description: "Running unit tests with covereage report"
    steps:
      - run: yarn test:ci:coverage --maxWorkers=10

jobs:
  lint:
    executor: node_10
    steps:
      - checkout
      - restore_cache: *restore_yarn_cache
      - install_dependencies
      - save_cache: *save_yarn_cache
      - build_artefacts
      - lint_code
  type_check:
    executor: node_10
    steps:
      - checkout
      - restore_cache: *restore_yarn_cache
      - install_dependencies
      - build_artefacts
      - type_check
  bundlesize_check:
    executor: node_10
    steps:
      - checkout
      - restore_cache: *restore_yarn_cache
      - install_dependencies
      - build_artefacts
      - check_artefacts_bundlesizes
  build_test_unit_node_8:
    executor: node_8
    steps:
      - checkout
      - restore_cache: *restore_yarn_cache
      - install_dependencies
      - build_artefacts
      - unit_test_with_coverage
  build_test_unit_node_10:
    executor: node_10
    steps:
      - checkout
      - restore_cache: *restore_yarn_cache
      - install_dependencies
      - build_artefacts
      - unit_test_with_coverage

workflows:
  version: 2
  build_and_test:
    jobs:
      - lint
      - type_check:
          requires:
            - lint
      - build_test_unit_node_8:
          requires:
            - type_check
      - build_test_unit_node_10:
          requires:
            - type_check
      - bundlesize_check:
          requires:
            - build_test_unit_node_8
            - build_test_unit_node_10
